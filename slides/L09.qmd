---
title: "Two-Way ANOVA"
subtitle: "STA5176: Statistical Modeling"
author: "Dr. Seals"
format: 
  revealjs:
    theme: dark2
    self-contained: false
    slide-number: false
    footer: "[STA5176 - Statistical Modeling](https://samanthaseals.github.io/STA5176)"
    width: 1600
    height: 900
    chalkboard: true
    df-print: paged
    html-math-method: katex
editor: source
---

## Introduction

- Previously, we discussed one-way ANOVA.

    - One-way ANOVA has one factor, or grouping variable.
    
- Now, we will discuss ANOVA for designs with multiple factors.

    - We will focus on two-way ANOVA, however, this can be extended to multiple factors.
    
- We will see that as we increase the number of factors, the ANOVA table becomes more complicated.

## Factorial Treatment Structure

- **Factorial treatment structure:** An experiment in which the response (*y*) is observed at all factor-level combinations of the independent variables.

- Consider two factors:

    - A with three levels (*a* = 3)
    - B with two levels (*b* = 2)
    
- We have *ab* = 6 treatment groups:

    - A1B1, A1B2
    - A2B1, A2B2
    - A3B1, A3B2

- We now have what we call replicates in each treatment group.

    - i.e., more than one value observed for each A1B1, A1B2, A2B1, A2B2, A3B1, and A3B2.
    
- This allows for us to examine interaction terms.

## Interaction Terms

- **Interaction**: The difference in the mean responses for two levels of one factor is not constant across levels of the second factor.

- Generic definition: The relationship between the outcome and one factor depends on the level of a second factor.

- Graphically, if we plot the means of the treatment groups, we should see either an intersection or a potential intersection.

## Interaction Terms

- Example for demonstration:

    - An experimenter is interested in examining the effects of nitrogen and phosphorous on the yield of a crop. Two levels of each have been selected for the study. For nitrogen, 40 and 60 pounds per plot are examined. For phosphorous, 10 and 20 pounds per plot are examined. Thus, there are four possible combinations:
    
        - N40, P10
        - N40, P20
        - N60, P10
        - N60, P20

## Interaction Terms

<img src="images/L09a.png">

## Interaction Terms

<img src="images/L09b.png">

## Two-Way ANOVA

- We can now write the ANOVA model as follows:

$$ y_{ijk} = \mu + \tau_i + \beta_j + \tau \beta_{ij} + \varepsilon_{ijk} $$
- where

    - $y_{ijk}$ is the *k*<sup>th</sup> observation from the *i*<sup>th</sup> level of factor A and the *j*<sup>th</sup> level of factor B
    
    - $\mu$ is the overall mean
    
    - $\tau_i$ is the effect due to the *i*<sup>th</sup> level of factor A 
    
    - $\beta_j$ is the effect due to  the *j*<sup>th</sup> level of factor B
    
    - $\tau \beta_{ij}$ is the interaction effect of the *i*<sup>th</sup> level of factor A with the *j*<sup>th</sup> level of factor B 
    
    - $\varepsilon_{ijk} \sim N(0, \sigma^2)$, the random error associated with the *k*<sup>th</sup> observation from the *i*<sup>th</sup> level of factor A and the *j*<sup>th</sup> level of factor B

## Two-Way ANOVA

- Using the two-way ANOVA model, we represent the mean of each treatment group:

$$ \text{E}[y_{ijk}] = \mu_{ij} = \mu + \tau_i + \beta_j + \tau \beta_{ij}  $$
- We can also simplify the two-way ANOVA model if there is not an interaction between factors A and B:

$$ y_{ijk} = \mu + \tau_i + \beta_j + \varepsilon_{ijk} $$

## Two-Way ANOVA

- The ANOVA table we are working towards:


| **Source** | **SS**           | **df**           | **MS**           | **_F_** |
|------------------------------|------------------|------------------|------------------|---------|
| Main Effect - Factor A  | SS<sub>A</sub> | df<sub>A</sub> | MS<sub>A</sub> | *F*<sub>A</sub> |
| Main Effect - Factor B  | SS<sub>B</sub> | df<sub>B</sub> | MS<sub>B</sub> | *F*<sub>B</sub> |
| Interaction - A $\times$ B  | SS<sub>AB</sub> | df<sub>AB</sub> | MS<sub>AB</sub> | *F*<sub>AB</sub> |
| Error      | SS<sub>E</sub>   | df<sub>E</sub>   | MS<sub>E</sub>   |         |
| Total      | SS<sub>Tot</sub> | df<sub>Tot</sub> |                  |         |

## Two-Way ANOVA

- We will not review the SS formulas, however, they are developed in the book beginning on page 815.

- The df will take the same form as before:

    - df<sub>Tot</sub> = *abn* - 1, or the total sample size - 1
    - df<sub>A</sub> = *a* - 1, or the number of groups in factor A - 1
    - df<sub>B</sub> = *b* - 1, or the number of groups in factor B - 1
    - df<sub>AB</sub> = (*a* - 1)(*b* - 1), or df<sub>A</sub> $\times$ df<sub>B</sub>
    - df<sub>E</sub> = *ab*(*n* - 1), or df<sub>Tot</sub> - (df<sub>A</sub> + df<sub>B</sub> + df<sub>AB</sub>)

- The MS will take the same form as before: MS<sub>X</sub> = SS<sub>X</sub> / df<sub>X</sub>

- The *F* will take the same form as before: MS<sub>X</sub> / MS<sub>E</sub>

## Two-Way ANOVA: R Syntax

- We will again use `lm()` and `anova()` OR `aov()` and `summary()` to analyze the data.

- As we are specifying our model, we will:
    - include additional terms with +
    - include interaction terms with :
    
```{r, echo = TRUE, eval = FALSE}
m <- lm([outcome] ~ [factor A] + [factor B] + [factor A]:[factor B],
        data = [dataset])
anova(m)
```

OR

```{r, echo = TRUE, eval = FALSE}
m <- aov([outcome] ~ [factor A] + [factor B] + [factor A]:[factor B],
         data = [dataset])
summary(m)
```

## Two-Way ANOVA: Example

- An experiment was conducted to investigate the heat loss for five different designs for commercial thermal panes. The researcher, in order to obtain results that would be applicable throughout most regions of the country, decided to evaluate the panes at five temperatures: 0$^\circ$F, 20$^\circ$F, 40$^\circ$F, 60$^\circ$F, and 80$^\circ$F. A sample of 10 panes of each design was obtained. Two panes of each design were randomly assigned to each of the five exterior temperature settings. The interior temperature of the test was controlled at 70$^\circ$F for all five exterior temperatures. The heat losses associated with the five pane designs are given in the Google Sheet linked below.

```{r, echo = TRUE, warning = FALSE, message = FALSE}
library(gsheet)
library(tidyverse)
data <- as_tibble(gsheet2tbl("https://docs.google.com/spreadsheets/d/1MNgpPyIp9tkcTgN3UHklayqQS1tT0pFDYS9oIIqICtg/edit#gid=0"))
```

## Two-Way ANOVA: Example

```{r, echo = TRUE}
head(data)
```

## Two-Way ANOVA: Example

```{r, echo = TRUE}
m1 <- lm(`Heat Loss` ~ as.factor(`Pane Design`) + as.factor(`Ext Temp (F)`) + as.factor(`Pane Design`):as.factor(`Ext Temp (F)`), data = data)
anova(m1)
```

## Two-Way ANOVA: Testing Interactions

**Hypotheses**

- $H_0:$ There is not an interaction between factor A and factor B ($\tau \beta_{1,1} = ... = \tau \beta_{a,b} = 0$)
- $H_1:$ There is an interaction between factor A and factor B (at least one $\tau \beta_{i,j} \ne 0$)

**Test Statistic** 

- $F_{\text{AB}} = \text{MS}_{\text{AB}} / \text{MS}_{\text{E}}$

***p*-Value**

- $p = \text{P}[F_{\text{df}_{\text{AB}}, \text{df}_{\text{E}}} \ge F_{\text{AB}}]$

**Rejection Region**

- Reject $H_0$ if $p < \alpha$

## Two-Way ANOVA: Example

```{r, echo = TRUE}
anova(m1)
```

## Two-Way ANOVA: Example {.smaller}

**Hypotheses**

- $H_0:$ There is not an interaction between the pane design and the external temperature
- $H_1:$ There is an interaction between the pane design and the external temperature

**Test Statistic** 

- $F_{\text{AB}} = 3.566$

***p*-Value**

- $p = 0.002$

**Conclusion/Interpretation**

- Reject $H_0$. There is sufficient evidence that there is an interaction between the pane design and the external temperature. 
- That is, the relationship between heat loss and external temperature depends on the pane design. 
- Alternatively, we can say that the relationship between heat loss and pane design depends on the external temperature.
    
## Main Effects

- What happens when the interaction term is not statistically significant? (i.e., $p \ge \alpha$)

    - We will remove the interaction term from our model, rerun, and test factors A and B individually.

**With the interaction:**
```{r, echo = TRUE, eval = FALSE}
m <- lm([outcome] ~ [factor A] + [factor B] + [factor A]:[factor B],
        data = [dataset])
anova(m)
```

**Without the interaction:**
```{r, echo = TRUE, eval = FALSE}
m <- lm([outcome] ~ [factor A] + [factor B],
        data = [dataset])
anova(m)
```

- When the interaction is in the model, **we cannot comment on main effects**!

## Main Effects: Example

- Recall the heat loss example. Suppose that the interaction term was not significant. Let's now remove the interaction term.

```{r, echo = TRUE}
m2 <- lm(`Heat Loss` ~ as.factor(`Pane Design`) + as.factor(`Ext Temp (F)`), data = data)
anova(m2)
```

## Main Effects: Testing Factor A

**Hypotheses:**

- $H_0:$ There is not a main effect of factor A ($\tau_1 = ... = \tau_a = 0$)
- $H_1:$ There is a main effect of factor A (at least one $\tau_i \ne 0$)

**Test Statistic** 

- $F_{\text{A}} = \text{MS}_{\text{A}} / \text{MS}_{\text{E}}$ 

***p*-Value**

- $p = \text{P}[F_{\text{df}_{\text{A}}, \text{df}_{\text{E}}} \ge F_{\text{A}}]$

**Rejection Region**

- Reject $H_0$ if $p < \alpha$

## Main Effects: Testing Factor B

**Hypotheses:**

- $H_0:$ There is not a main effect of factor B ($\beta_1 = ... = \beta_b = 0$)
- $H_1:$ There is a main effect of factor B (at least one $\beta_j \ne 0$)

**Test Statistic** 

- $F_{\text{B}} = \text{MS}_{\text{B}} / \text{MS}_{\text{E}}$ 

***p*-Value**

- $p = \text{P}[F_{\text{df}_{\text{B}}, \text{df}_{\text{E}}} \ge F_{\text{B}}]$

**Rejection Region**

- Reject $H_0$ if $p < \alpha$

## Main Effects: Example

- In the heat loss example,

```{r, echo = TRUE}
anova(m2)
```

## Main Effects: Example {.smaller}

**Hypotheses:**

- $H_0:$ There is not a main effect of pane design ($\tau_1 = ... = \tau_5 = 0$)
- $H_1:$ There is a main effect of pain design (at least one $\tau_i \ne 0$)

**Test Statistic** 

- $F_{\text{A}} = 3.263$ 

***p*-Value**

- $p = 0.021$

**Conclusion/Interpretation**

- Reject $H_0$. There is sufficient evidence to suggest a main effect of pane design.
- That is, there is a difference in heat loss across the different pane designs.

## Main Effects: Example {.smaller}

**Hypotheses:**

- $H_0:$ There is not a main effect of external temperature ($\beta_1 = ... = \beta_5 = 0$)
- $H_1:$ There is a main effect of external temperature (at least one $\beta_j \ne 0$)

**Test Statistic** 

- $F_{\text{B}} = 26.604$ 

***p*-Value**

- $p < 0.001$

**Conclusion/Interpretation**

- Reject $H_0$. There is sufficient evidence to suggest a main effect of external temperature.
- That is, there is a difference in heat loss across different external temperatures.

## Conclusions

- We have expanded what we know about ANOVA to include two factors

- We first must test for an interaction between factors A and B

- If the interaction is not statistically significant, we should remove it from the model for simplicity in explanations

- Next lecture:

    - What to do when an interaction is present -- how can we communicate the meaning to others?
    
    - What to do when there is not an interaction, but there are significant main effects -- how can we communicate the meaning to others?





















